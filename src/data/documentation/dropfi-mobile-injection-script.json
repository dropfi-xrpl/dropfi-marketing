{
  "title": "DropFi Mobile Injection Script",
  "description": "Understand how the DropFi mobile app injects the window.xrpl provider into web views. This script enables DApps to communicate with the DropFi mobile wallet through React Native WebView.",
  "sections": [
    {
      "type": "section",
      "id": "overview",
      "title": "Overview",
      "components": [
        {
          "type": "header",
          "title": "DropFi Mobile Injection Script",
          "subtitle": "How window.xrpl is injected into mobile web views",
          "icon": "Smartphone"
        },
        {
          "type": "text",
          "text": "The DropFi mobile injection script is injected into web views within the DropFi mobile app. This script creates the `window.xrpl` object that DApps use to interact with the DropFi mobile wallet. The script uses React Native WebView's postMessage API to communicate with the native mobile app.",
          "variant": "body"
        },
        {
          "type": "feature-grid",
          "features": [
            {
              "title": "React Native WebView",
              "description": "Uses ReactNativeWebView.postMessage for native communication",
              "icon": "Smartphone",
              "color": "bg-primary-500/10"
            },
            {
              "title": "Duplicate Prevention",
              "description": "Checks for existing provider to prevent multiple injections",
              "icon": "Shield",
              "color": "bg-primary-500/10"
            },
            {
              "title": "Event-Driven Architecture",
              "description": "Implements event listeners for wallet state changes",
              "icon": "Code",
              "color": "bg-primary-500/10"
            },
            {
              "title": "Promise-Based API",
              "description": "All methods return promises for async operations",
              "icon": "Code",
              "color": "bg-primary-500/10"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "id": "full-script",
      "title": "Complete Injection Script",
      "components": [
        {
          "type": "text",
          "text": "Here is the complete mobile injection script that gets injected into web views:",
          "variant": "body"
        },
        {
          "type": "code-block",
          "title": "DropFi Mobile Injection Script",
          "code": "(function () {\n    if (!window.ReactNativeWebView) return;\n    if (window.xrpl && window.xrpl.isDropFi) { true; return; }\n  \n    console.log('[DropFi] Injected XRPL provider');\n    const XRPLProvider = {\n      isDropFi: true,\n      selectedAddress: null,\n      selectedNetwork: null,\n      connectedAccounts: [],\n      network: null,\n      endpoint: null,\n      listeners: {},\n      resolvers: {},\n  \n      _emit(event, payload) {\n        (this.listeners[event] || []).forEach((fn) => fn(payload));\n      },\n  \n      on(event, cb) {\n        this.listeners[event] = this.listeners[event] || [];\n        this.listeners[event].push(cb);\n      },\n  \n      off(event, cb) {\n        if (!this.listeners[event]) return;\n        this.listeners[event] = this.listeners[event].filter((fn) => fn !== cb);\n      },\n  \n      createXRPLPromise(method, data = {}) {\n        return new Promise((resolve) => {\n          this.resolvers[method] = (result) => {\n            if (method === 'xrpl_stateRequest' && result) {\n              this.selectedAddress = result.selectedAddress;\n              this.connectedAccounts = result.connectedAccounts;\n              this.network = result.network;\n              this.endpoint = result.endpoint;\n              this._emit('xrpl_selectedAddress', result.selectedAddress);\n              this._emit('xrpl_connectedAccounts', result.connectedAccounts);\n              this._emit('xrpl_selectedNetwork', result.network);\n            } else if (method === 'xrpl_connect' && result) {\n              this.selectedAddress = result;\n              this.connectedAccounts = [result];\n              this._emit('xrpl_selectedAddress', result);\n              this._emit('xrpl_connectedAccounts', [result]);\n            } else if (method === 'xrpl_disconnect') {\n              const old = this.selectedAddress;\n              this.selectedAddress = null;\n              this.connectedAccounts = [];\n              this._emit('xrpl_selectedAddress', null);\n              this._emit('xrpl_connectedAccounts', []);\n              this._emit('xrpl_disconnect', old);\n            } else if (method === 'xrpl_switchNetwork' && result) {\n              this.network = result.network;\n              this.endpoint = result.endpoint;\n              this._emit('xrpl_selectedNetwork', result.network);\n            }\n  \n            resolve(result);\n          };\n  \n          window.ReactNativeWebView.postMessage(\n            JSON.stringify({ method, params: data })\n          );\n        });\n      },\n  \n      handleHostResponse(message) {\n        try {\n          const { method, payload } = JSON.parse(message?.data || '{}');\n          if (this.resolvers[method]) {\n            this.resolvers[method](payload);\n          }\n        } catch (err) {\n          console.warn('[DropFi] Failed to handle host response', err);\n        }\n      },\n  \n      connect: (data) => XRPLProvider.createXRPLPromise('xrpl_connect', { data }),\n      disconnect: () => XRPLProvider.createXRPLPromise('xrpl_disconnect'),\n      signMessage: (message) => XRPLProvider.createXRPLPromise('xrpl_signMessage', { message }),\n      sendTransaction: (tx) => XRPLProvider.createXRPLPromise('xrpl_sendTransaction', { tx }),\n      switchNetwork: (networkId) => XRPLProvider.createXRPLPromise('xrpl_switchNetwork', { networkId }),\n      changeAccount: (account) => XRPLProvider.createXRPLPromise('xrpl_changeAccount', { account }),\n      initialize: () => XRPLProvider.createXRPLPromise('xrpl_stateRequest'),\n  \n      isConnected: () => !!XRPLProvider.selectedAddress,\n    };\n  \n    window.addEventListener('message', (event) => {\n      XRPLProvider.handleHostResponse(event);\n    });\n  \n    window.xrpl = XRPLProvider;\n  })();",
          "language": "javascript"
        }
      ]
    },
    {
      "type": "section",
      "id": "key-differences",
      "title": "Key Differences from Web Version",
      "components": [
        {
          "type": "text",
          "text": "The mobile injection script has several key differences from the web version:",
          "variant": "body"
        },
        {
          "type": "tip-grid",
          "tips": [
            {
              "type": "info",
              "title": "React Native WebView Check",
              "description": "First checks if window.ReactNativeWebView exists before injecting",
              "icon": "Smartphone"
            },
            {
              "type": "info",
              "title": "Duplicate Prevention",
              "description": "Checks if window.xrpl already exists and is a DropFi provider to prevent double injection",
              "icon": "Shield"
            },
            {
              "type": "info",
              "title": "Message Format",
              "description": "Uses JSON.stringify for postMessage instead of direct object passing",
              "icon": "Code"
            },
            {
              "type": "warning",
              "title": "Response Parsing",
              "description": "Parses message.data as JSON in handleHostResponse, with error handling",
              "icon": "AlertTriangle"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "id": "key-components",
      "title": "Key Components",
      "components": [
        {
          "type": "text",
          "text": "The mobile injection script consists of several key components:",
          "variant": "body"
        },
        {
          "type": "step-list",
          "steps": [
            {
              "step": 1,
              "title": "Environment Check",
              "description": "Verifies ReactNativeWebView exists and prevents duplicate injection",
              "details": "Only injects if running in a React Native WebView and no existing DropFi provider is found"
            },
            {
              "step": 2,
              "title": "XRPLProvider Object",
              "description": "The main provider object that implements the window.xrpl API",
              "details": "Contains state properties (selectedAddress, network, etc.) and methods for wallet interaction"
            },
            {
              "step": 3,
              "title": "Event System",
              "description": "Implements on/off/_emit for event-driven communication",
              "details": "Allows DApps to listen for wallet state changes like address changes or network switches"
            },
            {
              "step": 4,
              "title": "Promise-Based Methods",
              "description": "createXRPLPromise creates promises that resolve when the app responds",
              "details": "Each method (connect, disconnect, etc.) uses this pattern to handle async communication"
            },
            {
              "step": 5,
              "title": "Native Communication",
              "description": "Uses ReactNativeWebView.postMessage to communicate with the native app",
              "details": "Messages are JSON stringified and sent to the native layer for processing"
            },
            {
              "step": 6,
              "title": "State Synchronization",
              "description": "Automatically updates internal state when responses are received",
              "details": "Updates selectedAddress, connectedAccounts, network, and endpoint based on app responses"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "id": "communication-flow",
      "title": "Communication Flow",
      "components": [
        {
          "type": "text",
          "text": "Understanding how the script communicates with the DropFi mobile app:",
          "variant": "body"
        },
        {
          "type": "tip-grid",
          "tips": [
            {
              "type": "info",
              "title": "Request Flow",
              "description": "DApp calls window.xrpl.connect() → createXRPLPromise → ReactNativeWebView.postMessage → Native app receives message",
              "icon": "ArrowRight"
            },
            {
              "type": "info",
              "title": "Response Flow",
              "description": "Native app sends response → window.addEventListener receives → handleHostResponse → JSON.parse → resolver called → Promise resolves",
              "icon": "ArrowRight"
            },
            {
              "type": "info",
              "title": "Error Handling",
              "description": "handleHostResponse includes try-catch to gracefully handle JSON parsing errors",
              "icon": "Shield"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "id": "public-api",
      "title": "Public API Methods",
      "components": [
        {
          "type": "text",
          "text": "The window.xrpl object exposes the following public methods (same as web version):",
          "variant": "body"
        },
        {
          "type": "api-endpoints",
          "endpoints": [
            {
              "method": "POST",
              "endpoint": "connect(data)",
              "description": "Initiates connection to DropFi wallet",
              "params": "data: object (optional) - returns Promise<string>"
            },
            {
              "method": "POST",
              "endpoint": "disconnect()",
              "description": "Disconnects from the wallet",
              "params": "None - returns Promise<void>"
            },
            {
              "method": "POST",
              "endpoint": "signMessage(message)",
              "description": "Signs a message using the connected wallet",
              "params": "message: string - returns Promise<string>"
            },
            {
              "method": "POST",
              "endpoint": "sendTransaction(tx)",
              "description": "Sends a transaction to the XRP Ledger",
              "params": "tx: object - returns Promise<string>"
            },
            {
              "method": "POST",
              "endpoint": "switchNetwork(networkId)",
              "description": "Switches the active network",
              "params": "networkId: string - returns Promise<object>"
            },
            {
              "method": "POST",
              "endpoint": "changeAccount(account)",
              "description": "Changes the active account",
              "params": "account: string - returns Promise<void>"
            },
            {
              "method": "GET",
              "endpoint": "initialize()",
              "description": "Initializes and requests current wallet state",
              "params": "None - returns Promise<object>"
            },
            {
              "method": "GET",
              "endpoint": "isConnected()",
              "description": "Checks if wallet is currently connected",
              "params": "None - returns boolean"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "id": "event-system",
      "title": "Event System",
      "components": [
        {
          "type": "text",
          "text": "The injection script supports an event system for listening to wallet state changes (same as web version):",
          "variant": "body"
        },
        {
          "type": "code-block",
          "title": "Event Usage Example",
          "code": "// Listen for address changes\nwindow.xrpl.on('xrpl_selectedAddress', (address) => {\n  console.log('Address changed:', address);\n});\n\n// Listen for network changes\nwindow.xrpl.on('xrpl_selectedNetwork', (network) => {\n  console.log('Network changed:', network);\n});\n\n// Listen for disconnect events\nwindow.xrpl.on('xrpl_disconnect', (oldAddress) => {\n  console.log('Disconnected from:', oldAddress);\n});\n\n// Remove event listener\nconst handler = (address) => console.log(address);\nwindow.xrpl.on('xrpl_selectedAddress', handler);\nwindow.xrpl.off('xrpl_selectedAddress', handler);",
          "language": "javascript"
        },
        {
          "type": "text",
          "text": "Available events: xrpl_selectedAddress, xrpl_connectedAccounts, xrpl_selectedNetwork, xrpl_disconnect",
          "variant": "small"
        }
      ]
    }
  ]
}

